<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Binary Annotation Tool</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px;
      position: relative;
    }
    #card {
      border: 2px solid #ccc;
      border-radius: 10px;
      padding: 20px;
      display: inline-block;
      min-width: 400px;
      background-color: #f0f0f0;
      margin-bottom: 20px;
    }
    .highlight {
      background-color: lightgreen;
      border: 2px solid green;
    }
    #counter {
      margin-top: 20px;
    }
    .key-controls {
      margin-top: 30px;
      display: grid;
      grid-template-areas:
        ". w ."
        "a s d";
      gap: 10px;
      justify-content: center;
      align-items: center;
    }
    .key {
      display: inline-block;
      border: 1px solid #000;
      padding: 10px 15px;
      border-radius: 5px;
      font-weight: bold;
      min-width: 60px;
    }
    #key-w { grid-area: w; }
    #key-a { grid-area: a; }
    #key-s { grid-area: s; }
    #key-d { grid-area: d; }
    #top-buttons {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #top-buttons button {
      padding: 6px 10px;
      font-size: 14px;
    }
    #save-status {
      font-size: 14px;
      margin-left: 10px;
    }
    .saved {
      color: green;
    }
    .unsaved {
      color: red;
    }
  </style>
</head>
<body>
  <div id="top-buttons">
    <button onclick="saveAnnotations()">üíæ Save</button>
    <button onclick="document.getElementById('fileInput').click()">üìÅ Open</button>
    <span id="save-status" class="unsaved">‚úó Unsaved Changes</span>
    <input type="file" id="fileInput" style="display:none" />
  </div>

  <h2 id="question">Loading question...</h2>
  <div id="card">Loading data...</div>
  <div id="counter"></div>

  <div class="key-controls">
    <div class="key" id="key-w">W<br>Next</div>
    <div class="key" id="key-a">A<br>No</div>
    <div class="key" id="key-s">S<br>Previous</div>
    <div class="key" id="key-d">D<br>Yes</div>
  </div>

  <script>
    let config, data = [], currentIndex = 0;
    let annotations = {};
    let originalFileName = '';
    let isSaved = false;

    function updateSaveStatus() {
      const status = document.getElementById('save-status');
      if (isSaved) {
        status.textContent = '‚úì All changes saved';
        status.className = 'saved';
      } else {
        status.textContent = '‚úó Unsaved Changes';
        status.className = 'unsaved';
      }
    }

    async function loadFiles() {
      try {
        config = await fetch('config.json').then(r => r.json());
        originalFileName = config.dataFile;
        data = await fetch(originalFileName).then(r => r.json());
        data.forEach((item, i) => {
          annotations[i] = 'not_annotated';
        });
        currentIndex = findFirstUnannotated();
        isSaved = false;
        updateSaveStatus();
        render();
      } catch (err) {
        document.getElementById('card').innerText = 'Failed to load config or data file.';
        console.error(err);
      }
    }

    function findFirstUnannotated() {
      for (let i = 0; i < data.length; i++) {
        if (annotations[i] === 'not_annotated') return i;
      }
      return 0;
    }

    function render() {
      const datapoint = data[currentIndex];
      const fields = config.fields.map(field => `${field}: ${datapoint[field]}`).join('<br>');
      document.getElementById('question').innerText = `Question: ${config.question}`;
      document.getElementById('card').innerHTML = `${fields}`;

      const yes = annotations[currentIndex] === true;
      const no = annotations[currentIndex] === false;
      document.getElementById('key-a').classList.toggle('highlight', no);
      document.getElementById('key-d').classList.toggle('highlight', yes);

      updateCounter();
    }

    function updateCounter() {
      const total = data.length;
      const annotated = Object.values(annotations).filter(v => v !== 'not_annotated').length;
      document.getElementById('counter').innerText =
        `Seen: ${currentIndex + 1} / ${total}, Annotated: ${annotated}, Left: ${total - annotated}`;
    }

    function saveAnnotations() {
      const output = data.map((item, i) => ({
        ...item,
        annotation: annotations[i] ?? 'not_annotated'
      }));
      const blob = new Blob([JSON.stringify(output, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'annotated_' + originalFileName;
      a.click();
      isSaved = true;
      updateSaveStatus();
    }

    function loadAnnotatedFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const loadedData = JSON.parse(e.target.result);
        data = loadedData;
        originalFileName = 'loaded_data.json';
        annotations = {};
        data.forEach((item, i) => {
          annotations[i] = item.annotation !== undefined ? item.annotation : 'not_annotated';
        });
        currentIndex = findFirstUnannotated();
        isSaved = false;
        updateSaveStatus();
        render();
      };
      reader.readAsText(file);
    }

    document.getElementById('fileInput').addEventListener('change', function() {
      if (this.files.length > 0) {
        loadAnnotatedFile(this.files[0]);
      }
    });

    window.addEventListener('beforeunload', function(e) {
      const unsaved = Object.values(annotations).some(v => v === 'not_annotated');
      if (!isSaved && unsaved) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
      }
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'a') {
        annotations[currentIndex] = false;
        currentIndex = Math.min(currentIndex + 1, data.length - 1);
        isSaved = false;
      } else if (e.key === 'd') {
        annotations[currentIndex] = true;
        currentIndex = Math.min(currentIndex + 1, data.length - 1);
        isSaved = false;
      } else if (e.key === 's') {
        currentIndex = Math.max(0, currentIndex - 1);
      } else if (e.key === 'w') {
        currentIndex = Math.min(currentIndex + 1, data.length - 1);
      }
      updateSaveStatus();
      render();
    });

    loadFiles();
  </script>
</body>
</html>
